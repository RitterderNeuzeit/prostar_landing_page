name: CI - Checks & Conditional E2E

on:
  push:
    branches: [main, master, "Branch-von-mir-erstellt-jonas"]
  pull_request:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20 and setup pnpm
        uses: pnpm/action-setup@v2
        with:
          node-version: "20"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prettier check
        run: pnpm run format:check

      - name: Duplication check
        run: pnpm run duplication:check

      - name: TypeScript check
        run: pnpm run check

      - name: Run unit tests
        run: pnpm test

  e2e-email:
    name: E2E - Email Flow (guarded)
    runs-on: ubuntu-latest
    needs: checks
    if: >-
      github.event_name != 'pull_request' &&
      secrets.EMAIL_USER &&
      secrets.EMAIL_PASSWORD &&
      secrets.ALLOW_E2E_EMAILS == 'true' &&
      contains(secrets.E2E_ALLOWED_RECIPIENTS, secrets.TEST_EMAIL)
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack & prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run E2E email flow (guarded)
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          SITE_URL: ${{ secrets.SITE_URL }}
          TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
        run: |
          echo "Running gated E2E: will send email to $TEST_EMAIL"
          npx tsx scripts/e2e-customer-flow.ts --email "$TEST_EMAIL"
